<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Encodage Pain Quotidien</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .raw { background: #ffe6e6; }
        .fixed { background: #e6ffe6; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .cache-info {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test d'Encodage - Pain Quotidien</h1>
        
        <div class="cache-info">
            <h3>Cache actuel:</h3>
            <div id="cache-status">Vérification...</div>
            <button onclick="clearCache()">Vider le cache</button>
            <button onclick="checkCache()">Vérifier le cache</button>
        </div>

        <button onclick="testDirect()">Test Direct (sans cache)</button>
        <button onclick="testWithEncoding()">Test avec Correction d'Encodage</button>
        <button onclick="testFromCache()">Test depuis Cache</button>

        <div id="raw-content" class="section raw" style="display:none;">
            <h3>Contenu Brut (sans correction):</h3>
            <div id="raw-text"></div>
        </div>

        <div id="fixed-content" class="section fixed" style="display:none;">
            <h3>Contenu Corrigé (avec EncodingFixService):</h3>
            <div id="fixed-text"></div>
        </div>

        <div id="cache-content" class="section" style="display:none; background: #e6f3ff;">
            <h3>Contenu du Cache:</h3>
            <div id="cache-text"></div>
        </div>

        <div id="error-content" class="error" style="display:none;">
            <div id="error-text"></div>
        </div>
    </div>

    <script>
        // Service de correction d'encodage (copie de EncodingFixService)
        class EncodingFixService {
            static fixEncoding(text) {
                if (!text) return text;
                
                // Décoder les entités HTML
                let fixed = text
                    .replace(/&eacute;/g, 'é')
                    .replace(/&egrave;/g, 'è')
                    .replace(/&ecirc;/g, 'ê')
                    .replace(/&euml;/g, 'ë')
                    .replace(/&agrave;/g, 'à')
                    .replace(/&acirc;/g, 'â')
                    .replace(/&auml;/g, 'ä')
                    .replace(/&icirc;/g, 'î')
                    .replace(/&iuml;/g, 'ï')
                    .replace(/&ocirc;/g, 'ô')
                    .replace(/&ouml;/g, 'ö')
                    .replace(/&ugrave;/g, 'ù')
                    .replace(/&ucirc;/g, 'û')
                    .replace(/&uuml;/g, 'ü')
                    .replace(/&ccedil;/g, 'ç')
                    .replace(/&aelig;/g, 'æ')
                    .replace(/&oelig;/g, 'œ')
                    .replace(/&rsquo;/g, "'")
                    .replace(/&lsquo;/g, "'")
                    .replace(/&rdquo;/g, '"')
                    .replace(/&ldquo;/g, '"')
                    .replace(/&hellip;/g, '...')
                    .replace(/&ndash;/g, '–')
                    .replace(/&mdash;/g, '—')
                    .replace(/&nbsp;/g, ' ')
                    .replace(/&amp;/g, '&');

                return fixed;
            }
        }

        // Gestion du cache
        function checkCache() {
            const quoteCache = localStorage.getItem('branham_quote_cache_v2');
            const lastUpdate = localStorage.getItem('branham_last_update_v2');
            
            let status = '';
            if (quoteCache) {
                const data = JSON.parse(quoteCache);
                status += `Cache trouvé: ${Object.keys(data).length} entrée(s)<br>`;
                status += `Dernière mise à jour: ${lastUpdate || 'Inconnue'}<br>`;
                
                // Afficher un aperçu du contenu
                for (const key of Object.keys(data)) {
                    const content = data[key];
                    if (content && content.quote) {
                        status += `Aperçu: "${content.quote.substring(0, 100)}..."<br>`;
                        break;
                    }
                }
            } else {
                status = 'Aucun cache trouvé';
            }
            
            document.getElementById('cache-status').innerHTML = status;
        }

        function clearCache() {
            localStorage.removeItem('branham_quote_cache_v2');
            localStorage.removeItem('branham_last_update_v2');
            document.getElementById('cache-status').innerHTML = 'Cache vidé !';
            hideAll();
        }

        function hideAll() {
            document.getElementById('raw-content').style.display = 'none';
            document.getElementById('fixed-content').style.display = 'none';
            document.getElementById('cache-content').style.display = 'none';
            document.getElementById('error-content').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('error-text').innerHTML = message;
            document.getElementById('error-content').style.display = 'block';
        }

        // Test direct depuis l'API
        async function testDirect() {
            hideAll();
            
            try {
                const response = await fetch('https://branham.org/fr/quoteoftheday', {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const html = await response.text();
                
                // Parser le contenu
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extraire la citation (adapter selon la structure HTML)
                const quoteElement = doc.querySelector('.quote, .citation, .daily-quote, p') || 
                                   doc.querySelector('body');
                
                const rawText = quoteElement ? quoteElement.textContent : 'Contenu non trouvé';
                
                document.getElementById('raw-text').innerHTML = rawText;
                document.getElementById('raw-content').style.display = 'block';
                
            } catch (error) {
                showError(`Erreur lors de la récupération: ${error.message}`);
            }
        }

        // Test avec correction d'encodage
        async function testWithEncoding() {
            hideAll();
            
            try {
                const response = await fetch('https://branham.org/fr/quoteoftheday');
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const quoteElement = doc.querySelector('.quote, .citation, .daily-quote, p') || 
                                   doc.querySelector('body');
                
                const rawText = quoteElement ? quoteElement.textContent : 'Contenu non trouvé';
                const fixedText = EncodingFixService.fixEncoding(rawText);
                
                document.getElementById('fixed-text').innerHTML = fixedText;
                document.getElementById('fixed-content').style.display = 'block';
                
            } catch (error) {
                showError(`Erreur lors de la récupération avec encodage: ${error.message}`);
            }
        }

        // Test depuis le cache
        function testFromCache() {
            hideAll();
            
            const quoteCache = localStorage.getItem('branham_quote_cache_v2');
            
            if (!quoteCache) {
                showError('Aucun cache trouvé. Utilisez d\'abord "Test Direct" pour créer du contenu.');
                return;
            }
            
            try {
                const data = JSON.parse(quoteCache);
                let cacheContent = '';
                
                for (const key of Object.keys(data)) {
                    const content = data[key];
                    if (content) {
                        cacheContent += `<strong>Clé:</strong> ${key}<br>`;
                        cacheContent += `<strong>Contenu:</strong> ${JSON.stringify(content, null, 2)}<br><br>`;
                    }
                }
                
                document.getElementById('cache-text').innerHTML = cacheContent || 'Cache vide';
                document.getElementById('cache-content').style.display = 'block';
                
            } catch (error) {
                showError(`Erreur lors de la lecture du cache: ${error.message}`);
            }
        }

        // Initialisation
        window.onload = function() {
            checkCache();
        };
    </script>
</body>
</html>
